<html>
    <head>
        <link rel="stylesheet" type="text/css" href="htpicker://file_resource?filepath=css/ui-darkness/jquery-ui-1.8.2.custom.css&amp;mime_type=text/css">

        <script type="text/javascript" src="htpicker://file_resource?filepath=js/jquery-1.4.2.min.js&amp;mime_type=text/javascript"></script>
        <script type="text/javascript" src="htpicker://file_resource?filepath=js/jquery-ui-1.8.2.custom.min.js&amp;mime_type=text/javascript"></script>

        <style>
            body, div, a { font-family: 'Droid Sans', sans-serif; font-size: xx-large; }
            body { background: #111; }
            a.item { display: block; padding: 0.2em; }
            a.item:link,
            a.item:active,
            a.item:hover,
            a.item:visited,
            a.item:focus {
                text-decoration: none;
                outline: none;
                vertical-align: middle;
            }
            a.item img { vertical-align: middle; height: 1.8em; }
            a.item span { vertical-align: middle; }
        </style>
    </head>

    <body>
        <div id="files"></div>
        <script>
            var old_el = null;

            var play_file = function(fullpath)
            {
                $.get('htpicker://play_file?fullpath=' + fullpath);
            }

            var activate = function(fullpath, type)
            {
                if(type == 'directory')
                    load_files(fullpath);
                else
                    play_file(fullpath);
            }

            var htmlDecode = function(input)
            {
                var e = document.createElement('div');
                e.innerHTML = input;
                return e.childNodes[0].nodeValue;
            }

            var scrollCentered = function(el, percentage, sweep_pct)
            {
                var win = $(window);
                var sweep_area = win.height() * sweep_pct;

                // *0.5 because half of the buffer goes above
                // and the other half implicitly goes below
                var modifier = -(percentage * sweep_area - sweep_area/2);

                var offset = el.offset().top - win.height()/2 + el.outerHeight()/2 + modifier;
                win.scrollTop(offset);
            }

            var focus_index = 0;
            var num_items = 0;

            var load_files = function(path) {
                var qs = '';
                if(path)
                    qs = '?directory=' + encodeURIComponent(path);

                $.getJSON('htpicker://list_files' + qs, function(data) {
                    var files = data['files'];
                    $('#files').html('');
                    num_items = files.length;
                    for(var i = 0; i < num_items; i++)
                    {
                        var css_classes = 'ui-widget-header item';

                        var focusin_cb = function(i, num_items) {
                            return function(ev) {
                                var el = $('#file-'+i);
                                el.addClass("ui-state-active");
                                var percentage = 1.0 * i / num_items;
                                scrollCentered(el, percentage, 0.5);
                                focus_index = i;
                            };
                        }(i, num_items);

                        var focusout_cb = function(i) {
                            return function(ev) {
                                $('#file-'+i).removeClass("ui-state-active");
                            };
                        }(i);

                        if(files[i]['icon'] == 'directory')
                            var icon = 'htpicker://file_resource?filepath=images/nuvola/gnome-fs-directory-visiting.svg&mime_type=image/svg+xml';
                        else if(files[i]['icon'] == 'video')
                            var icon = 'htpicker://file_resource?filepath=images/nuvola/mplayer.svg&mime_type=image/svg+xml';
                        else if(files[i]['icon'] == 'game')
                            var icon = 'htpicker://file_resource?filepath=images/nuvola/gamepad.svg&mime_type=image/svg+xml';
                        else
                            var icon = '';

                        var item = (
                            $('<a>')
                                .attr('id', 'file-'+i)
                                .attr('class', css_classes)
                                .focusin(focusin_cb)
                                .focusout(focusout_cb)
                                .attr('href', '#')
                                .click(function(file) {
                                    return function(ev) {
                                        activate(file['fullpath'], file['type']);
                                    };
                                }(files[i]))
                                .html('<img src="' + icon + '"> <span>' + files[i]['display_name'] + '</span>')
                        );
                        $('#files').append(item);
                        if(i == 0)
                            item.focus();
                        focus_index = 0;
                    }
                });
            }

            $(function() {
                $.getJSON('htpicker://get_initial_dir', function(data) {
                    var initial_dir = data['initial_dir'];
                    load_files(initial_dir);
                });

                $(document).keydown(function(ev) {
                    if(ev.which == $.ui.keyCode.DOWN)
                    {
                        if(focus_index < num_items-1)
                        {
                            focus_index++;
                            $('#file-'+focus_index).focus();
                        }
                        return false;
                    }

                    if(ev.which == $.ui.keyCode.UP)
                    {
                        if(focus_index > 0)
                        {
                            focus_index--;
                            $('#file-'+focus_index).focus();
                        }
                        return false;
                    }
                });
            });
        </script>
    </body>
</html>
