<html>
    <head>
        <link rel="stylesheet" type="text/css" href="css/ui-darkness/jquery-ui-1.8.2.custom.css" />
        <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.8.2.custom.min.js"></script>
        <style>
            * { font-family: 'Droid Sans', sans-serif; font-size: xx-large; }
            body { background: #111; }
            div.item { padding: 10px; }
            div.item a:link,
            div.item a:active,
            div.item a:hover,
            div.item a:visited { text-decoration: none; }
        </style>
    </head>

    <body>
        <center><div id="player" style="display: none;"></div></center>
        <div id="files"></div>
        <script>
            var have_video = false;
            var old_el = null;

            function full_url(prefix, filename)
            {
                return prefix + encodeURI(filename);
            }

            function activate_file(el, prefix, filename, fullpath)
            {
                if(old_el)
                    $(old_el).removeClass('ui-state-active');
                $(el).addClass('ui-state-active');
                old_el = el;

                var player = $('#player');
                $('body').append(full_url(prefix, filename)); // debug
                if(!have_video)
                {
                    player.html('<video height="40%" width="75%" src="' + full_url(prefix, filename) + '" autoplay>');
                    player.slideDown('fast');
                    have_video = true;
                }
                else
                {
                    $('#player > video')[0].pause();
                    player.fadeOut('fast');
                    player.html('<video height="40%" width="75%" src="' + full_url(prefix, filename) + '" autoplay>');
                    $('#player > video')[0].play();
                    player.fadeIn('slow');
                }
            }
            function activate_dir(el, prefix, filename, fullpath)
            {
                load_files(fullpath);
            }

            function htmlDecode(input)
            {
                var e = document.createElement('div');
                e.innerHTML = input;
                return e.childNodes[0].nodeValue;
            }


            function load_files(path) {
                var qs = '';
                if(path)
                    qs = '?directory=' + encodeURI(path);

                $.getJSON('myapp://list_files' + qs, function(data) {
                    var prefix = data['prefix'];
                    var files = data['files'];
                    $('#files').html('');
                    for(var i = 0; i < files.length; i++)
                    {
                        var css_classes = 'ui-widget-header item';

                        var onclick = files[i]['type'] == 'directory' ? 'activate_dir' : 'activate_file';

                        $('#files').append(
                            '<div id="one" class="' + css_classes + '">' +
                                '<a href="#" onclick="' + onclick + '(this.parentNode, \'' + prefix + '\', \'' + files[i]['filename'] + '\', \'' + files[i]['fullpath'] + '\');">' +
                                    files[i]['display_name'] +
                                '</a>' +
                            '</div>'
                        );
                    }
                });
            }

            $(function() {
                $.getJSON('myapp://get_initial_dir', function(data) {
                    var initial_dir = data['initial_dir'];
                    load_files(initial_dir);
                });
            });
        </script>
    </body>
</html>
