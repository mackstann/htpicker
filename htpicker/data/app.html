<html>
    <head>
        <link rel="stylesheet" type="text/css" href="htpicker://file_resource?filepath=css/ui-darkness/jquery-ui-1.8.2.custom.css&amp;mime_type=text/css">

        <script type="text/javascript" src="htpicker://file_resource?filepath=js/jquery-1.4.2.min.js&amp;mime_type=text/javascript"></script>
        <script type="text/javascript" src="htpicker://file_resource?filepath=js/jquery-ui-1.8.2.custom.min.js&amp;mime_type=text/javascript"></script>

        <style>
            body, div, a {
                font-family: 'Droid Sans', sans-serif;
                font-size: xx-large;
                cursor: none;
            }
            body { background: #111; overflow: hidden; }
            a.item { display: block; padding: 0.2em; }
            a.item:link,
            a.item:active,
            a.item:hover,
            a.item:visited,
            a.item:focus {
                text-decoration: none;
                outline: none;
                vertical-align: middle;
            }
            a.item img { vertical-align: middle; height: 1.8em; }
            a.item span { vertical-align: middle; }
        </style>
    </head>

    <body>
        <div id="files"></div>
        <script>
            var last_folder_entry_action = null;

            var icon_urls = {
                'directory': 'htpicker://file_resource?filepath=images/nuvola/gnome-fs-directory-visiting.svg&mime_type=image/svg+xml',
                'video': 'htpicker://file_resource?filepath=images/nuvola/mplayer.svg&mime_type=image/svg+xml',
                'game': 'htpicker://file_resource?filepath=images/nuvola/gamepad.svg&mime_type=image/svg+xml'
            };

            var icons = {};

            var preload_images = function()
            {
                for(var key in icon_urls)
                {
                    var img = document.createElement('img');
                    img.src = icon_urls[key];
                    icons[key] = img;
                }
            }

            var activate = function(fullpath, type, display_name)
            {
                if(type == 'directory')
                {
                    if(display_name == '&#8593; Parent Folder')
                        last_folder_entry_action = 'ascend';
                    else
                        last_folder_entry_action = 'descend';

                    $('#files').hide("slide", {
                        'direction': last_folder_entry_action == 'descend' ? 'left' : 'right',
                        'mode': 'hide' }, 150);

                    load_files(fullpath);
                }
                else
                {
                    $('#files').hide();
                    $.get('htpicker://play_file?fullpath=' + fullpath);
                    setTimeout(function() { $('#files').show(); }, 5000);
                }
            }

            var go_parent_directory = function()
            {
                $('#files a').first().click();
            }

            var move_selection_up = function()
            {
                if(focus_index > 0)
                {
                    focus_index--;
                    $('#file-'+focus_index).focus();
                }
            }

            var move_selection_down = function()
            {
                if(focus_index < num_items-1)
                {
                    focus_index++;
                    $('#file-'+focus_index).focus();
                }
            }

            var activate_current_selection = function()
            {
                $('#file-'+focus_index).click();
            }

            var scrollCentered = function(el, percentage, sweep_pct)
            {
                var win = $(window);
                var sweep_area = win.height() * sweep_pct;

                // *0.5 because half of the buffer goes above
                // and the other half implicitly goes below
                var modifier = -(percentage * sweep_area - sweep_area/2);

                var offset = el.offset().top - win.height()/2 + el.outerHeight()/2 + modifier;
                win.scrollTop(offset);
            }

            var focus_index = 0;
            var num_items = 0;

            var load_files = function(path) {
                var qs = '';
                if(path)
                    qs = '?directory=' + encodeURIComponent(path);

                $.getJSON('htpicker://list_files' + qs, function(data) {
                    var files = data['files'];
                    $('#files').html('');
                    num_items = files.length;
                    for(var i = 0; i < num_items; i++)
                    {
                        var focusin_cb = function(i, num_items) {
                            return function(ev) {
                                $('#files').show();
                                var el = $('#file-'+i);
                                el.addClass("ui-state-active");
                                var percentage = 1.0 * i / num_items;
                                scrollCentered(el, percentage, 0.5);
                                focus_index = i;
                            };
                        }(i, num_items);

                        var focusout_cb = function(i) {
                            return function(ev) {
                                $('#file-'+i).removeClass("ui-state-active");
                            };
                        }(i);

                        var icon_name = files[i]['icon'];
                        var icon_url = icon_name ? icons[icon_name].src : '';

                        var item = (
                            $('<a>')
                                .attr('id', 'file-'+i)
                                .attr('class', 'ui-widget-header item')
                                .focusin(focusin_cb)
                                .focusout(focusout_cb)
                                .attr('href', '#')
                                .click(function(file) {
                                    return function(ev) {
                                        activate(file['fullpath'], file['type'], file['display_name']);
                                    };
                                }(files[i]))
                                .html('<img src="' + icon_url + '"> <span>' + files[i]['display_name'] + '</span>')
                        );

                        $('#files').append(item);
                    }

                    if(last_folder_entry_action)
                        $('#files').show("slide", {
                            'direction': last_folder_entry_action == 'descend' ? 'right' : 'left',
                            'mode': 'show'
                        }, 250, function() { $('#files > a')[0].focus(); });
                    else
                        $('#files > a')[0].focus();

                    focus_index = 0;
                });
            }

            $(function() {
                preload_images();

                $.getJSON('htpicker://get_initial_dir', function(data) {
                    var initial_dir = data['initial_dir'];
                    load_files(initial_dir);
                });

                $(document).keydown(function(ev) {
                    if(ev.which == $.ui.keyCode.DOWN)
                    {
                        move_selection_down();
                        return false;
                    }
                    if(ev.which == $.ui.keyCode.UP)
                    {
                        move_selection_up();
                        return false;
                    }
                });
            });
        </script>
    </body>
</html>
